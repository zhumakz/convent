{% extends base_template %}

{% block title %}Login{% endblock %}

{% block content %}
<div id="loginForm">
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Login</button>
    </form>
</div>

<div id="verifyPopup" style="display: none;">
    <form method="post" action="{% url 'verify_login' %}">
        {% csrf_token %}
        {{ verification_form.as_p }}
        <button type="submit">Verify</button>
    </form>
    <p id="sms-info">
        {% if remaining_time %}
            You can resend the SMS in <span id="timer">{{ remaining_time }}</span> seconds.
        {% endif %}
    </p>
    <button id="resendButton" onclick="resendSMS()" style="display: none;">Resend</button>
</div>

<script>
    function showVerificationPopup() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('verifyPopup').style.display = 'block';
    }

    function startTimer(duration, display, resendButton) {
        var timer = duration, minutes, seconds;
        var interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = seconds;
            if (--timer < 0) {
                clearInterval(interval);
                resendButton.style.display = 'block';
                display.textContent = "0";
            }
        }, 1000);
    }

    function resendSMS() {
        document.getElementById('resendButton').style.display = 'none';
        document.getElementById('sms-info').innerText = 'Sending SMS...';
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const phone_number = '{{ request.session.phone_number }}';
        fetch("{% url 'resend_sms' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
            },
            body: new URLSearchParams({'phone_number': phone_number})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                document.getElementById('sms-info').innerHTML = 'You can resend the SMS in <span id="timer">60</span> seconds.';
                startTimer(60, document.querySelector('#timer'), document.getElementById('resendButton'));
            } else {
                document.getElementById('sms-info').innerText = data.message || 'Error sending SMS. Please try again later.';
                document.getElementById('resendButton').style.display = 'block';
            }
        })
        .catch(() => {
            document.getElementById('sms-info').innerText = 'Error sending SMS. Please try again later.';
            document.getElementById('resendButton').style.display = 'block';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% if show_popup %}
            showVerificationPopup();
            {% if remaining_time %}
                startTimer({{ remaining_time }}, document.querySelector('#timer'), document.getElementById('resendButton'));
            {% endif %}
        {% endif %}
    });
</script>
{% endblock %}
