{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'style/qr/qr.css' %}">
    <link rel="stylesheet" href="{% static 'style/404/error.css' %}">
{% endblock %}

{% block content %}
    <section class="qr">
        <div class="popup-container">
            <div class="top">
                <a class="top__button popup-close" href="{% url 'profile' %}">
                    <svg width="46" height="46">
                        <use href="{% static 'image/icons.svg' %}#back "></use>
                    </svg>
                </a>
                <span class="top__title">{% trans "–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥" %}</span>
            </div>
            <form id="qr-form" action="{% url 'handle_qr_data' %}" method="post">
                {% csrf_token %}
                <input type="hidden" id="qr_data" name="qr_data" required>
            </form>
            <div id="my-qr-reader" class="qr__content">
                <div id="video-container">
                    <video id="qr-video"></video>
                </div>
                <div class="display_none_qr">
                    <label>
                        Highlight Style
                        <select id="scan-region-highlight-style-select">
                            <option value="default-style">Default style</option>
                            <option value="example-style-1">Example custom style 1</option>
                            <option value="example-style-2">Example custom style 2</option>
                        </select>
                    </label>
                    <label>
                        <input id="show-scan-region" type="checkbox">
                        Show scan region canvas
                    </label>
                </div>
                <div class="display_none_qr">
                    <select id="inversion-mode-select">
                        <option value="original">Scan original (dark QR code on bright background)</option>
                        <option value="invert">Scan with inverted colors (bright QR code on dark background)</option>
                        <option value="both">Scan both</option>
                    </select>
                    <br>
                </div>

                <input class="hide" id="hd-1" type="checkbox">
               <label for="hd-1"> <img  src="./image/mechanism.png"  alt="scan" width="40" height="40" /></label>
                <div>
                    <b>–í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã: </b>
                    <span id="cam-has-camera"></span>
                    <br>
                    <div>
                        <b>–í–∞—à–∞ –∫–∞–º–µ—Ä–∞:</b><br/>
                        <select id="cam-list">
                            <option value="environment" selected>Environment Facing (default)</option>
                            <option value="user">–õ–∏—Ü–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                        </select>
                    </div>
                    <b>–§–æ–Ω–∞—Ä–∏–∫: </b>
                    <span id="cam-has-flash"></span>
                    <div>
                        <button id="flash-toggle">üì∏ –§–æ–Ω–∞—Ä–∏–∫: <span id="flash-state">–æ—Ç–∫–ª</span></button>
                    </div>
                </div>
                <input class="hide" id="hd-2" type="checkbox">

                <div class="display_none_qr">
                    <br>
                    <b>Detected QR code: </b>
                    <span id="cam-qr-result">None</span>
                    <br>
                    <b>Last detected at: </b>
                    <span id="cam-qr-result-timestamp"></span>
                    <br>
                    <button id="start-button">Start</button>
                    <button id="stop-button">Stop</button>
                    <hr>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import QrScanner from "{% static 'js/qr-scaner/qr-scanner.min.js' %}";

        const video = document.getElementById('qr-video');
        const videoContainer = document.getElementById('video-container');
        const camHasCamera = document.getElementById('cam-has-camera');
        const camList = document.getElementById('cam-list');
        const camHasFlash = document.getElementById('cam-has-flash');
        const flashToggle = document.getElementById('flash-toggle');
        const flashState = document.getElementById('flash-state');
        const camQrResult = document.getElementById('cam-qr-result');
        const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
        const fileSelector = document.getElementById('file-selector');
        const fileQrResult = document.getElementById('file-qr-result');
        const qr_data = document.getElementById('qr_data');
        const qr_form = document.getElementById('qr-form');
        let scanner;

        function setResult(label, result) {
            console.log(result.data);
            label.textContent = result.data;
            camQrResultTimestamp.textContent = new Date().toString();
            label.style.color = 'teal';
            clearTimeout(label.highlightTimeout);
            label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
            scanner.stop();
            qr_data.value = result.data;
            qr_form.submit();
            console.log(result.data);
        }


        scanner = new QrScanner(video, result => setResult(camQrResult, result), {
            onDecodeError: error => {
                camQrResult.textContent = error;
                camQrResult.style.color = 'inherit';
            },
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        scanner.start().then(() => {
            updateFlashAvailability();
            QrScanner.listCameras(true).then(cameras => cameras.forEach(camera => {
                const option = document.createElement('option');
                option.value = camera.id;
                option.text = camera.label;
                camList.add(option);
            }));
        });

        QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);

        window.scanner = scanner;
        

        function updateFlashAvailability() {
            scanner.hasFlash().then(hasFlash => {
                camHasFlash.textContent = hasFlash;
                flashToggle.style.display = hasFlash ? 'inline-block' : 'none';
            });
        }

        document.getElementById('start-button').addEventListener('click', () => {
            scanner.start();
        });

        document.getElementById('stop-button').addEventListener('click', () => {
            if (scanner) {
                scanner.stop();
            }
        });

        document.getElementById('scan-region-highlight-style-select').addEventListener('change', (e) => {
            videoContainer.className = e.target.value;
            scanner._updateOverlay();
        });

        document.getElementById('show-scan-region').addEventListener('change', (e) => {
            const input = e.target;
            const label = input.parentNode;
            label.parentNode.insertBefore(scanner.$canvas, label.nextSibling);
            scanner.$canvas.style.display = input.checked ? 'block' : 'none';
        });

        document.getElementById('inversion-mode-select').addEventListener('change', event => {
            scanner.setInversionMode(event.target.value);
        });

        camList.addEventListener('change', event => {
            scanner.setCamera(event.target.value).then(updateFlashAvailability);
        });

        flashToggle.addEventListener('click', () => {
            scanner.toggleFlash().then(() => flashState.textContent = scanner.isFlashOn() ? 'on' : 'off');
        });
    </script>

    <style>
        #video-container {
            max-width: 350px;
            max-height: 400px;
            overflow: hidden;
            position: relative;
        }

        #qr-video {
            width: 100%; /* –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            height: auto; /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω */
            display: block;
        }

        div {
            margin-bottom: 16px;
        }

        #video-container {
            line-height: 0;
        }

        #video-container.example-style-1 .scan-region-highlight-svg,
        #video-container.example-style-1 .code-outline-highlight {
            stroke: #64a2f3 !important;
        }

        #video-container.example-style-2 {
            position: relative;
            width: max-content;
            height: max-content;
            overflow: hidden;
        }

        #video-container.example-style-2 .scan-region-highlight {
            border-radius: 30px;
            outline: rgba(0, 0, 0, .25) solid 50vmax;
        }

        #video-container.example-style-2 .scan-region-highlight-svg {
            display: none;
        }

        #video-container.example-style-2 .code-outline-highlight {
            stroke: rgba(255, 255, 255, .5) !important;
            stroke-width: 15 !important;
            stroke-dasharray: none !important;
        }

        #flash-toggle {
            display: none;
        }

        hr {
            margin-top: 32px;
        }

        input[type="file"] {
            display: block;
            margin-bottom: 16px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {#    <script src="{% static 'js/html5-qrcode.min.js' %}"></script>#}
    {#    <script>#}
    {#        let isProcessing = false;#}
    {#        const html5QrCodeScanner = new Html5QrcodeScanner("my-qr-reader", {fps: 10, qrbox: 250});#}
    {##}
    {#        html5QrCodeScanner.render(onScanSuccess);#}
    {##}
    {#        function onScanSuccess(decodedText, decodedResult) {#}
    {#            if (isProcessing) {#}
    {#                return;#}
    {#            }#}
    {##}
    {#            isProcessing = true;#}
    {#            console.log(`Scanned QR Code: ${decodedText}`);#}
    {##}
    {#            // –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ QR-–∫–æ–¥–∞#}
    {#            document.getElementById('qr_data').value = decodedText;#}
    {##}
    {#            // –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ä–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏#}
    {#            document.getElementById('qr-form').submit();#}
    {#        }#}
    {#    </script>#}
{% endblock %}
